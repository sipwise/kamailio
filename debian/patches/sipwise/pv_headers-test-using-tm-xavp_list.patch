From: Victor Seva <vseva@sipwise.com>
Date: Fri, 17 Jan 2020 10:30:24 +0100
Subject: pv_headers: test using tm xavp_list

Change-Id: Ifafefc2772f273ce0d7c8c6b1af7177a14cf601a
---
 src/modules/pv_headers/pv_headers.c | 28 +++++++++++++++++++++++++++-
 1 file changed, 27 insertions(+), 1 deletion(-)

diff --git a/src/modules/pv_headers/pv_headers.c b/src/modules/pv_headers/pv_headers.c
index 4d41b55..fcffde7 100644
--- a/src/modules/pv_headers/pv_headers.c
+++ b/src/modules/pv_headers/pv_headers.c
@@ -272,13 +272,39 @@ void handle_tm_t(tm_cell_t *t, int type, struct tmcb_params* params)
 int handle_msg_cb(struct sip_msg *msg, unsigned int flags, void *cb)
 {
     int cbs = TMCB_REQUEST_FWDED | TMCB_RESPONSE_FWDED | TMCB_RESPONSE_IN | TMCB_ON_BRANCH_FAILURE;
+    int branch;
+    tm_cell_t *t = NULL;
+    sr_xavp_t **backup_xavps = NULL;
 
-    if (flags & (PRE_SCRIPT_CB|REQUEST_CB|ONREPLY_CB)) {
+    if(flags&ONREPLY_CB_TYPE) {
+        LM_DBG("ONREPLY_CB\n");
+    }
+    if(flags&REQUEST_CB_TYPE) {
+        LM_DBG("REQUEST_CB\n");
+    }
+
+    if (tmb.t_check(msg, &branch) == -1) {
+        LM_ERR("failed find UAC branch\n");
+    } else {
+       t = tmb.t_gett();
+       if(t == NULL || t == T_UNDEFINED) {
+           LM_DBG("cannot lookup the transaction\n");
+       } else {
+           LM_DBG("T:%p branch:%d\n", t, branch);
+           backup_xavps = xavp_set_list(&t->xavps_list);
+       }
+    }
+
+    if (flags & (PRE_SCRIPT_CB|REQUEST_CB|ONREPLY_CB_TYPE)) {
         if (tmb.register_tmcb( msg, 0, cbs, handle_tm_t, 0, 0) <=0) {
             LM_ERR("cannot register TM callbacks\n");
             return -1;
         }
         pv_collect_headers(msg, "1", NULL);
+        if(backup_xavps) {
+            xavp_set_list(backup_xavps);
+            LM_DBG("restored backup_xavps\n");
+       }
     } else {
         LM_ERR("unknown callback: %d\n", flags);
     }
