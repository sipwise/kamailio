From: Victor Seva <vseva@sipwise.com>
Date: Mon, 24 Oct 2016 11:34:39 +0200
Subject: sca: use onhold_bflag value only when set

Change-Id: Icc6d7edd407299b6de2f85ad8ecc5fe8d9b89339
---
 modules/sca/doc/sca_admin.xml | 3 ++-
 modules/sca/sca_call_info.c   | 4 ++++
 modules/sca/sca_util.c        | 8 ++++++--
 3 files changed, 12 insertions(+), 3 deletions(-)

diff --git a/modules/sca/doc/sca_admin.xml b/modules/sca/doc/sca_admin.xml
index 1108126..b376e41 100644
--- a/modules/sca/doc/sca_admin.xml
+++ b/modules/sca/doc/sca_admin.xml
@@ -268,7 +268,8 @@ modparam( "sca", "db_update_interval", 120 )
 		<para>
 		<para>
 		Which branch flag should be used by the module to identify if the call
-		is on-hold instead of parsing the sdp.
+		is on-hold instead of parsing the sdp. If the bflag not is set the
+		sdp will be parsed.
 		</para>
 		<para>
 		<emphasis>
diff --git a/modules/sca/sca_call_info.c b/modules/sca/sca_call_info.c
index 3d4b62a..738597e 100644
--- a/modules/sca/sca_call_info.c
+++ b/modules/sca/sca_call_info.c
@@ -1010,13 +1010,17 @@ sca_call_info_invite_request_handler( sip_msg_t *msg, sca_call_info *call_info,
     }
     
     if ( sca_call_is_held( msg )) {
+        LM_DBG("call is held\n");
 	state = SCA_APPEARANCE_STATE_HELD;
 	if ( call_info->state == SCA_APPEARANCE_STATE_HELD_PRIVATE ) {
+        LM_DBG("call is held private\n");
 	    state = SCA_APPEARANCE_STATE_HELD_PRIVATE;
 	} else {
+        LM_DBG("call is held public\n");
 	    state = SCA_APPEARANCE_STATE_HELD;
 	}
     } else if ( !SCA_STR_EMPTY( &to->tag_value )) {
+        LM_DBG("reinvite with state active, call not held\n");
 	/* this is a reINVITE from an SCA line that put the call on hold */
 	state = SCA_APPEARANCE_STATE_ACTIVE;
     } else if ( sca_call_info_is_line_seize_reinvite( msg, call_info,
diff --git a/modules/sca/sca_util.c b/modules/sca/sca_util.c
index 60c178c..0f4511a 100644
--- a/modules/sca/sca_util.c
+++ b/modules/sca/sca_util.c
@@ -454,8 +454,11 @@ sca_call_is_held( sip_msg_t *msg )
     int			rc;
 
     if(sca->cfg->onhold_bflag >= 0) {
-        LM_DBG("sca_call_is_held: skip parse_sdp and use onhold_bflag\n");
-        return isbflagset(0, (flag_t)sca->cfg->onhold_bflag);
+        LM_DBG("onhold_bflag param detected\n");
+        if(isbflagset(0, (flag_t)sca->cfg->onhold_bflag) == 1) {
+            LM_DBG("onhold_bflag set, skip parse_sdp and set held\n");
+            return ( 1 );
+        }
     }
     rc = parse_sdp( msg );
     if ( rc < 0 ) {
@@ -475,6 +478,7 @@ sca_call_is_held( sip_msg_t *msg )
 		stream != NULL;
 		n_str++, stream = get_sdp_stream( msg, n_sess, n_str )) {
 	    if ( stream->is_on_hold ) {
+            LM_DBG("sca_call_is_held: parse_sdp detected stream is on hold\n");
 		is_held = 1;
 		goto done;
 	    }
