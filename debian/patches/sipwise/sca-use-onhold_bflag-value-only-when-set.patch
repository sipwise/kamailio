From: Victor Seva <vseva@sipwise.com>
Date: Mon, 24 Oct 2016 11:34:39 +0200
Subject: sca: use onhold_bflag value only when set

Change-Id: Icc6d7edd407299b6de2f85ad8ecc5fe8d9b89339
---
 modules/sca/doc/sca_admin.xml | 3 ++-
 modules/sca/sca_util.c        | 6 ++++--
 2 files changed, 6 insertions(+), 3 deletions(-)

Index: kamailio/modules/sca/doc/sca_admin.xml
===================================================================
--- kamailio.orig/modules/sca/doc/sca_admin.xml	2016-10-24 14:35:19.558942674 +0200
+++ kamailio/modules/sca/doc/sca_admin.xml	2016-10-24 14:35:19.558942674 +0200
@@ -268,7 +268,8 @@
 		<para>
 		<para>
 		Which branch flag should be used by the module to identify if the call
-		is on-hold instead of parsing the sdp.
+		is on-hold instead of parsing the sdp. If the bflag not is set the
+		sdp will be parsed.
 		</para>
 		<para>
 		<emphasis>
Index: kamailio/modules/sca/sca_util.c
===================================================================
--- kamailio.orig/modules/sca/sca_util.c	2016-10-24 14:35:19.558942674 +0200
+++ kamailio/modules/sca/sca_util.c	2016-10-24 14:37:46.639396265 +0200
@@ -454,8 +454,10 @@
     int			rc;
 
     if(sca->cfg->onhold_bflag >= 0) {
-        LM_DBG("sca_call_is_held: skip parse_sdp and use onhold_bflag\n");
-        return isbflagset(0, (flag_t)sca->cfg->onhold_bflag);
+        if(isbflagset(0, (flag_t)sca->cfg->onhold_bflag) == 1) {
+            LM_DBG("onhold_bflag, skip parse_sdp and set held\n");
+            return ( 1 );
+        }
     }
     rc = parse_sdp( msg );
     if ( rc < 0 ) {
@@ -475,6 +477,7 @@
 		stream != NULL;
 		n_str++, stream = get_sdp_stream( msg, n_sess, n_str )) {
 	    if ( stream->is_on_hold ) {
+		LM_DBG( "sca_call_is_held: parse_sdp detected stream is on hold");
 		is_held = 1;
 		goto done;
 	    }
