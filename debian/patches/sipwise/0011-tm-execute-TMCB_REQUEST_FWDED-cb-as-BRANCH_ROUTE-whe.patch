From: Victor Seva <vseva@sipwise.com>
Date: Wed, 20 Nov 2019 17:41:08 +0100
Subject: tm: execute TMCB_REQUEST_FWDED cb as BRANCH_ROUTE when necessary

Change-Id: Idf1aa75b74b55423c241b76ec0ac956b06039aa4
---
 src/modules/tm/t_fwd.c | 17 +++++++++++------
 1 file changed, 11 insertions(+), 6 deletions(-)

diff --git a/src/modules/tm/t_fwd.c b/src/modules/tm/t_fwd.c
index 2ad86a3..a53c35d 100644
--- a/src/modules/tm/t_fwd.c
+++ b/src/modules/tm/t_fwd.c
@@ -376,15 +376,20 @@ static int prepare_new_uac( struct cell *t, struct sip_msg *i_req,
 					goto error03;
 				}
 			}
+			LM_DBG("++++++ calling cb TMCB_REQUEST_FWDED in BRANCH_ROUTE +++++\n");
+			/* run the specific callbacks for this transaction */
+			if (unlikely(has_tran_tmcbs(t, TMCB_REQUEST_FWDED)))
+				run_trans_callbacks( TMCB_REQUEST_FWDED , t, i_req, 0,
+						-i_req->REQ_METHOD);
+
 			tm_ctx_set_branch_index(T_BR_UNDEFINED);
 			set_route_type(backup_route_type);
+		} else {
+			/* run the specific callbacks for this transaction */
+			if (unlikely(has_tran_tmcbs(t, TMCB_REQUEST_FWDED)))
+				run_trans_callbacks( TMCB_REQUEST_FWDED , t, i_req, 0,
+						-i_req->REQ_METHOD);
 		}
-
-		/* run the specific callbacks for this transaction */
-		if (unlikely(has_tran_tmcbs(t, TMCB_REQUEST_FWDED)))
-			run_trans_callbacks( TMCB_REQUEST_FWDED , t, i_req, 0,
-					-i_req->REQ_METHOD);
-
 		if (likely( !(flags & UAC_DNS_FAILOVER_F) && i_req->dst_uri.s &&
 					i_req->dst_uri.len)){
 			/* no dns failover and non-empty dst_uri => use it as dst
