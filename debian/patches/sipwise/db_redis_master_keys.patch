From: Sipwise Development Team <support@sipwise.com>
Date: Wed, 24 Feb 2021 11:20:05 +0100
Subject: db_redis_master_keys

---
 src/modules/db_redis/redis_dbase.c | 16 ++++++++++++++++
 src/modules/db_redis/redis_table.c |  4 ++++
 2 files changed, 20 insertions(+)

diff --git a/src/modules/db_redis/redis_dbase.c b/src/modules/db_redis/redis_dbase.c
index 9d4898c..e774e22 100644
--- a/src/modules/db_redis/redis_dbase.c
+++ b/src/modules/db_redis/redis_dbase.c
@@ -400,6 +400,22 @@ static int db_redis_find_query_key(redis_key_t *key, const str *table_name,
         }
     }
 
+    // for value-less master keys
+    if (!key_name->len) {
+        // <version>:<table_name>:<type>
+        len = table->version_code.len + table_name->len + 1 + type_name->len + 1;
+        key_name->s = (char*)pkg_malloc(len);
+        if (!key_name->s) {
+            LM_ERR("Failed to allocate key memory\n");
+            goto err;
+        }
+        snprintf(key_name->s, len, "%.*s%.*s:%.*s",
+                table->version_code.len, table->version_code.s,
+                table_name->len, table_name->s,
+                type_name->len, type_name->s);
+        key_name->len = len-1;
+    }
+
     return 0;
 
 err:
diff --git a/src/modules/db_redis/redis_table.c b/src/modules/db_redis/redis_table.c
index a0842a5..e59bd5b 100644
--- a/src/modules/db_redis/redis_table.c
+++ b/src/modules/db_redis/redis_table.c
@@ -610,6 +610,10 @@ int db_redis_parse_keys(km_redis_con_t *con) {
                 column_name.s = start;
                 column_name.len = p - start;
                 start = ++p;
+
+                if (!column_name.len)
+                    break;
+
                 /*
                 LM_DBG("found column name '%.*s' in type '%.*s' for table '%.*s'\n",
                         column_name.len, column_name.s,
