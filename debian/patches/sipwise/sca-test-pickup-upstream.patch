From: Victor Seva <vseva@sipwise.com>
Date: Mon, 24 Apr 2017 11:16:44 +0200
Subject: sca: test pickup upstream

Change-Id: I51f849a3fbdd096d08cdea009a393df4065bcedd
---
 modules/sca/sca_call_info.c | 46 +++++++++++++++++++++++++++++++++++----------
 1 file changed, 36 insertions(+), 10 deletions(-)

diff --git a/modules/sca/sca_call_info.c b/modules/sca/sca_call_info.c
index fdf4d63..b02e15b 100644
--- a/modules/sca/sca_call_info.c
+++ b/modules/sca/sca_call_info.c
@@ -979,6 +979,9 @@ sca_call_info_invite_request_handler( sip_msg_t *msg, sca_call_info *call_info,
     str			state_str = STR_NULL;
     int			state = SCA_APPEARANCE_STATE_UNKNOWN;
     int			rc = -1;
+    str			*target_aor;
+    str			*to_tag, *from_tag;
+    int			slot_idx;
 
     /*
      * if we get here, one of the legs is an SCA endpoint. we want to know
@@ -991,11 +994,28 @@ sca_call_info_invite_request_handler( sip_msg_t *msg, sca_call_info *call_info,
 	goto done;
     }
 
-    if ( !SCA_CALL_INFO_IS_SHARED_CALLER( call_info )) {
+    if(SCA_CALL_INFO_IS_SHARED_CALLEE( call_info ) &&
+    		sca->rr_api->is_direction(msg, RR_FLOW_UPSTREAM)==0) {
+    	LM_DBG("callee is SCA and direction is 'upstream'\n");
+    	target_aor = to_aor;
+    	to_tag = &from->tag_value;
+    	from_tag = &to->tag_value;
+    	slot_idx = sca_uri_lock_shared_appearance(sca, target_aor);
+    	if(slot_idx>=0) {
+    		LM_DBG("appearance index for [%.*s] is %d\n",
+    			STR_FMT(target_aor), slot_idx);
+    		sca_hash_table_unlock_index(sca->appearances, slot_idx);
+    	}
+    } else if ( !SCA_CALL_INFO_IS_SHARED_CALLER( call_info )) {
 	/* caller isn't SCA, no more to do. update callee in reply handler. */
-	LM_DBG("caller isn't SCA, no more to do. update callee in reply handler\n");
+    	LM_DBG("caller isn't SCA, no more to do. update callee in reply handler\n");
 	rc = 1;
 	goto done;
+    } else {
+    	target_aor = from_aor;
+    	to_tag = &to->tag_value;
+    	from_tag = &from->tag_value;
+    	slot_idx = call_info->index;
     }
 
     /*
@@ -1006,11 +1026,12 @@ sca_call_info_invite_request_handler( sip_msg_t *msg, sca_call_info *call_info,
     if ( sca->tm_api->register_tmcb( msg, NULL, TMCB_RESPONSE_READY,
 			sca_call_info_response_ready_cb, NULL, NULL ) < 0 ) {
 	LM_ERR( "sca_call_info_invite_request_handler: failed to register "
-		"callback for INVITE %.*s ACK", STR_FMT( from_aor ));
+		"callback for INVITE %.*s ACK", STR_FMT( target_aor ));
 	goto done;
     }
-    
+
     if ( sca_call_is_held( msg )) {
+    	LM_DBG("call_is_held\n");
 	state = SCA_APPEARANCE_STATE_HELD;
 	if ( call_info->state == SCA_APPEARANCE_STATE_HELD_PRIVATE ) {
 	    state = SCA_APPEARANCE_STATE_HELD_PRIVATE;
@@ -1036,22 +1057,23 @@ sca_call_info_invite_request_handler( sip_msg_t *msg, sca_call_info *call_info,
 
     dialog.id.s = dlg_buf;
     if ( sca_dialog_build_from_tags( &dialog, sizeof( dlg_buf ),
-	    &msg->callid->body, &from->tag_value, &to->tag_value ) < 0 ) {
-	LM_ERR( "Failed to build dialog from tags" );
+	    &msg->callid->body, from_tag, to_tag ) < 0 ) {
+	LM_ERR( "Failed to build dialog from tags from_tag[%.*s] to_tag[%.*s]",
+		STR_FMT(from_tag), STR_FMT(to_tag));
 	return( -1 );
     }
 
-    if ( sca_appearance_update_index( sca, from_aor, call_info->index,
+    if ( sca_appearance_update_index( sca, target_aor, slot_idx,
 		state, NULL, NULL, &dialog ) != SCA_APPEARANCE_OK ) {
 	sca_appearance_state_to_str( state, &state_str );
 	LM_ERR( "Failed to update %.*s appearance-index %d to %.*s",
-		STR_FMT( from_aor ), call_info->index,
+		STR_FMT( target_aor ), slot_idx,
 		STR_FMT( &state_str ));
     }
 
-    if ( sca_notify_call_info_subscribers( sca, from_aor ) < 0 ) {
+    if ( sca_notify_call_info_subscribers( sca, target_aor ) < 0 ) {
 	LM_ERR( "Failed to call-info NOTIFY %.*s subscribers on INVITE",
-		STR_FMT( from_aor ));
+		STR_FMT( target_aor ));
 	goto done;
     }
 
@@ -2078,11 +2100,15 @@ sca_call_info_update( sip_msg_t *msg, char *p1, str *uri_to, str *uri_from )
     if ( sca_uri_is_shared_appearance( sca, &from_aor )) {
 	if (( update_mask & SCA_CALL_INFO_SHARED_CALLER )) {
 	    call_info.ua_shared |= SCA_CALL_INFO_SHARED_CALLER;
+	    LM_DBG("SCA_CALL_INFO_SHARED_CALLER[%.*s]\n",
+	    	STR_FMT(&from_aor));
 	}
     }
     if ( sca_uri_is_shared_appearance( sca, &to_aor )) {
 	if (( update_mask & SCA_CALL_INFO_SHARED_CALLEE )) {
 	    call_info.ua_shared |= SCA_CALL_INFO_SHARED_CALLEE;
+	    LM_DBG("SCA_CALL_INFO_SHARED_CALLEE[%.*s]\n",
+	    	STR_FMT(&to_aor));
 	}
     }
 
